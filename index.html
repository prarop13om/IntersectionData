<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏¢‡∏Å</title>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <style>
    html, body { height: 100%; margin: 0; }
    #app { height: 100%; display: flex; flex-direction: column; }
    header { padding: 10px 12px; box-shadow: 0 2px 8px rgba(0,0,0,.08); z-index: 1000; background: #fff; }
    header h1 { margin: 0; font-size: 18px; }
    header .sub { font-size: 12px; color: #666; }
    #map { flex: 1; }
    .leaflet-popup-content { font-size: 14px; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; background:#f2f4f7; margin-right:6px; font-size:12px; }
    .ctrl { display:flex; gap:8px; align-items:center; margin-top:6px; }
    .ctrl input { flex:1; padding:8px 10px; border:1px solid #e3e6eb; border-radius:10px; font-size:14px; }
    .ctrl button { padding:8px 10px; border:1px solid #e3e6eb; background:#fff; border-radius:10px; font-size:14px; }
    .toast { position: fixed; left: 50%; bottom: 16px; transform: translateX(-50%); background:#111; color:#fff; padding:8px 12px; border-radius:12px; font-size:12px; opacity:0.9; z-index: 2000; }
  .user-dot{width:18px;height:18px;border-radius:50%;background:#2b7bff;box-shadow:0 0 0 3px rgba(43,123,255,.25);position:relative}
.user-dot::after{content:"";position:absolute;inset:-6px;border-radius:50%;border:2px solid rgba(43,123,255,.45);animation:pulse 1.5s ease-out infinite}
@keyframes pulse{0%{transform:scale(.6);opacity:.9}100%{transform:scale(1.6);opacity:0}}
.user-dot{width:18px;height:18px;border-radius:50%;background:#2b7bff;box-shadow:0 0 0 3px rgba(43,123,255,.25);position:relative}
.user-dot::after{content:"";position:absolute;inset:-6px;border-radius:50%;border:2px solid rgba(43,123,255,.45);animation:pulse 1.5s ease-out infinite}
@keyframes pulse{0%{transform:scale(.6);opacity:.9}100%{transform:scale(1.6);opacity:0}}
.legend{background:#fff;padding:8px 10px;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,.08);font-size:12px}
.legend .row{display:flex;align-items:center;gap:6px;margin:4px 0}
.legend .sw{width:12px;height:12px;border-radius:3px;border:1px solid #333}
</style>
</head>
<body>
<div id="app">
  <header>
    <h1>‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏¢‡∏Å</h1>
    <div class="sub">‡∏î‡∏π‡∏´‡∏°‡∏∏‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ/‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏¢‡∏Å + ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô)</div>
    <div class="ctrl">
      <input id="search" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤: ‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏¢‡∏Å / ‡∏™‡∏ô. / ‡∏ö‡∏Å. / ‡∏ö‡∏ä. / ‡∏Ñ‡∏•‡∏∑‡πà‡∏ô" />
      <button id="locBtn">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏â‡∏±‡∏ô</button>
      <button id="reloadBtn">‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
    </div>
  </header>
  <div id="map"></div>
</div>
<div id="toast" class="toast" style="display:none"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<!-- PapaParse (‡πÑ‡∏ß‡πâ‡πÅ‡∏õ‡∏•‡∏á CSV ‡∏à‡∏≤‡∏Å Google Sheets) -->
<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
<script>
/*** ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ ***/
// 1) ‡πÉ‡∏™‡πà‡∏•‡∏¥‡∏á‡∏Å‡πå CSV ‡∏à‡∏≤‡∏Å Google Sheets (File > Share > Publish to web > ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡πà‡∏ô‡∏á‡∏≤‡∏ô‡πÄ‡∏õ‡πá‡∏ô CSV) ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏™‡πà‡πÑ‡∏ü‡∏•‡πå CSV ‡πÉ‡∏ô repo ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ä‡πâ‡∏•‡∏¥‡∏á‡∏Å‡πå RAW
// ====== ‡∏´‡∏•‡∏≤‡∏¢‡∏ä‡∏µ‡∏ï‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà (‡πÉ‡∏™‡πà‡∏•‡∏¥‡∏á‡∏Å‡πå CSV ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ä‡∏µ‡∏ï) ======
const INTERSECTION_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT01A1wCCz9aa_V7i2Hn6gmoOv-gjmc4hgJnqnX4vo6R9FMIlTwphEbJFS3y3F0OtBo0h_GBmtF56bL/pub?gid=1203231005&single=true&output=csv"; // ‡∏ä‡∏µ‡∏ï: Intersection (name, station, radio, lat, lng)
const STATION_CSV_URL      = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT01A1wCCz9aa_V7i2Hn6gmoOv-gjmc4hgJnqnX4vo6R9FMIlTwphEbJFS3y3F0OtBo0h_GBmtF56bL/pub?gid=705908281&single=true&output=csv";      // ‡∏ä‡∏µ‡∏ï: Station (station_name, division_name)
const DIVISION_CSV_URL     = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT01A1wCCz9aa_V7i2Hn6gmoOv-gjmc4hgJnqnX4vo6R9FMIlTwphEbJFS3y3F0OtBo0h_GBmtF56bL/pub?gid=940717141&single=true&output=csv";     // ‡∏ä‡∏µ‡∏ï: Division (division_name, bureau_name)
const BUREAU_CSV_URL       = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT01A1wCCz9aa_V7i2Hn6gmoOv-gjmc4hgJnqnX4vo6R9FMIlTwphEbJFS3y3F0OtBo0h_GBmtF56bL/pub?gid=193057135&single=true&output=csv";       // ‡∏ä‡∏µ‡∏ï: Bureau (bureau_name)


// 2) ‡∏Å‡∏≥‡∏´‡∏ô‡∏î mapping ‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÉ‡∏ô‡∏ä‡∏µ‡∏ï -> key ‡πÉ‡∏ô‡πÅ‡∏≠‡∏õ
// ‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÉ‡∏ô‡∏ä‡∏µ‡∏ï‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏ï‡∏≤‡∏°‡∏ô‡∏µ‡πâ (‡πÑ‡∏°‡πà‡∏™‡∏ô‡∏ï‡∏±‡∏ß‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏•‡πá‡∏Å‡πÉ‡∏´‡∏ç‡πà)
// Mapping ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ä‡∏µ‡∏ï Intersection ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
const COLS = {
  name: ["name","‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏¢‡∏Å","junction"],
  station: ["station","‡∏™‡∏ô./‡∏™‡∏†.","‡∏™‡∏ô.","‡∏™‡∏†."],
  radio: ["radio","‡∏Ñ‡∏•‡∏∑‡πà‡∏ô‡∏ß‡∏¥‡∏ó‡∏¢‡∏∏","‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà"],
  lat: ["lat","latitude","‡∏•‡∏∞‡∏ï‡∏¥‡∏à‡∏π‡∏î"],
  lng: ["lng","lon","longitude","‡∏•‡∏≠‡∏á‡∏à‡∏¥‡∏à‡∏π‡∏î"]
};

// Mapping ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ä‡∏µ‡∏ï Station
const COLS_STATION = {
  station_name: ["station_name","station","‡∏™‡∏ô.","‡∏™‡∏†."],
  division_name: ["division_name","division","‡∏ö‡∏Å."]
};

// Mapping ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ä‡∏µ‡∏ï Division
const COLS_DIVISION = {
  division_name: ["division_name","division","‡∏ö‡∏Å."],
  bureau_name: ["bureau_name","bureau","‡∏ö‡∏ä.","‡∏†."]
};

// Mapping ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ä‡∏µ‡∏ï Bureau
const COLS_BUREAU = {
  bureau_name: ["bureau_name","bureau","‡∏ö‡∏ä.","‡∏†."]
};

// ====== ‡∏Å‡∏é Normalization ‡πÅ‡∏•‡∏∞‡∏™‡∏µ‡∏ï‡∏≤‡∏° ‡∏ö‡∏Å. ======
const HIER = {
  juncToStation: { '‡∏õ‡∏ó‡∏∏‡∏°‡∏ß‡∏±‡∏ô': '‡∏™‡∏ô.‡∏õ‡∏ó‡∏∏‡∏°‡∏ß‡∏±‡∏ô' },
  stationToDivision: { '‡∏™‡∏ô.‡∏õ‡∏ó‡∏∏‡∏°‡∏ß‡∏±‡∏ô': '‡∏ö‡∏Å.‡∏ô.6' },
  divisionToBureau: { '‡∏ö‡∏Å.‡∏ô.6': '‡∏ö‡∏ä.‡∏ô.' }
};
const DIVISION_COLORS = {
  '‡∏ö‡∏Å.‡∏ô.1':'#e74c3c','‡∏ö‡∏Å.‡∏ô.2':'#e67e22','‡∏ö‡∏Å.‡∏ô.3':'#f1c40f','‡∏ö‡∏Å.‡∏ô.4':'#2ecc71',
  '‡∏ö‡∏Å.‡∏ô.5':'#1abc9c','‡∏ö‡∏Å.‡∏ô.6':'#3498db','‡∏ö‡∏Å.‡∏ô.7':'#9b59b6','‡∏ö‡∏Å.‡∏ô.8':'#34495e','‡∏ö‡∏Å.‡∏ô.9':'#16a085'
};
function normalizeUnitText(s){
  s = norm(s); if(!s) return '';
  // ‡∏£‡∏ß‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏ã‡πâ‡∏≠‡∏ô
  s = s.split(' ').filter(Boolean).join(' ');
  return s;
}
function getDivisionColor(divName){
  const d = normalizeUnitText(divName);
  return DIVISION_COLORS[d] || '#7f8c8d';
}
function normalizeHierarchy(row){
  const name = norm(row.name);
  let st = normalizeUnitText(row.station);
  if(!st && name && HIER.juncToStation[name]) st = normalizeUnitText(HIER.juncToStation[name]);
  let dv = normalizeUnitText(row.division);
  if(!dv && st && HIER.stationToDivision[st]) dv = normalizeUnitText(HIER.stationToDivision[st]);
  let bc = normalizeUnitText(row.bureau);
  if(!bc && dv && HIER.divisionToBureau[dv]) bc = normalizeUnitText(HIER.divisionToBureau[dv]);
  row.station = st || row.station;
  row.division = dv || row.division;
  row.bureau = bc || row.bureau;
  return row;
}
// ====== /Normalization ======

/*** ‡πÇ‡∏Ñ‡πâ‡∏î‡∏´‡∏•‡∏±‡∏Å ***/
let map, allMarkers = [], dataRows = [], userMarker = null, userCircle = null, watchId = null, following = true; const userIcon = L.divIcon({ className: 'user-dot', iconSize: [18,18] }); 

function toast(msg, ms=2000){
  const el = document.getElementById('toast');
  el.textContent = msg; el.style.display='block';
  setTimeout(()=>{ el.style.display='none'; }, ms);
}

function norm(s){ return (s||"").toString().trim(); }
function same(a,b){ return norm(a).toLowerCase()===norm(b).toLowerCase(); }
function normalizeHeader(h){
  const s = norm(h).toLowerCase();
  // ‡∏•‡∏ö‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏Å‡∏Ç‡∏£‡∏∞‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏ó‡∏µ‡πà‡∏û‡∏ö‡∏ö‡πà‡∏≠‡∏¢
  const rm = [' ','.','-','_','(',')','/'];
  let out = s;
  rm.forEach(ch=>{ out = out.split(ch).join(''); });
  out = out.replace('‡∏Å‡∏≠‡∏á‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏Å‡∏≤‡∏£','‡∏ö‡∏Å').replace('‡∏Å‡∏≠‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏≤‡∏Å‡∏≤‡∏£','‡∏ö‡∏ä').replace('‡∏™‡∏ô.‡∏™‡∏†.','‡∏™‡∏ô.‡∏™‡∏†');
  return out;
}
function colIdxByAliases(headers, aliases){
  const H = headers.map(normalizeHeader);
  for(const a of aliases){
    const key = normalizeHeader(a);
    const i = H.findIndex(h=>h===key);
    if(i!==-1) return i;
  }
  return -1;
}


function buildPopup(r){
  const lines = [
    '<div style="font-weight:600;font-size:15px;">${r.name||"(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠)"}</div>',
    '<div style="margin:6px 0;">'
      + (r.station?'<span class="pill">${normalizeUnitText(r.station)}</span>':'')
      + (r.division?'<span class="pill">${normalizeUnitText(r.division)}</span>':'')
      + (r.bureau?'<span class="pill">${normalizeUnitText(r.bureau)}</span>':'')
    + '</div>',
    r.radio?'<div>üìª <b>‡∏Ñ‡∏•‡∏∑‡πà‡∏ô:</b> ${r.radio}</div>':'',
    (r.station||r.division||r.bureau) ? (()=>{ const chain = [ r.name ? '"'+r.name+'"' : null, r.station, r.division, r.bureau ].filter(Boolean).map(x=>normalizeUnitText(x)).join(' ‚Üí '); return '<div>üß≠ <b>‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà:</b> ${chain}</div>'; })() : '',
    '<div>üìå <b>‡∏û‡∏¥‡∏Å‡∏±‡∏î:</b> ${r.lat?.toFixed? r.lat.toFixed(6):r.lat}, ${r.lng?.toFixed? r.lng.toFixed(6):r.lng}</div>'
  ].join('');
  return lines;
}</div>',
    '<div style="margin:6px 0;">'
      + (r.station?'<span class="pill">${r.station}</span>':'')
      + (r.division?'<span class="pill">${r.division}</span>':'')
      + (r.bureau?'<span class="pill">${r.bureau}</span>':'')
    + '</div>',
    r.radio?'<div>üìª <b>‡∏Ñ‡∏•‡∏∑‡πà‡∏ô:</b> ${r.radio}</div>':'',
    '<div>üß≠ <b>‡∏û‡∏¥‡∏Å‡∏±‡∏î:</b> ${r.lat?.toFixed? r.lat.toFixed(6):r.lat}, ${r.lng?.toFixed? r.lng.toFixed(6):r.lng}</div>'
  ].join('');
  return lines;
}

function clearMarkers(){
  allMarkers.forEach(m => map.removeLayer(m));
  allMarkers = [];
}

function plotMarkers(rows){
  clearMarkers();
  const grp = L.featureGroup();
  rows.forEach(r => {
    if(isFinite(r.lat) && isFinite(r.lng)){
      const color = getDivisionColor(r.division);
      const m = L.circleMarker([r.lat, r.lng], {
        radius: 8, weight: 1, color: '#333', fillColor: color, fillOpacity: 0.95
      }).bindPopup(buildPopup(r));
      m.addTo(grp);
      allMarkers.push(m);
    }
  });
  grp.addTo(map);
  if (rows.length){ map.fitBounds(grp.getBounds().pad(0.15)); }
  updateLegend(rows);
}
  });
  grp.addTo(map);
  if (rows.length){ map.fitBounds(grp.getBounds().pad(0.15)); }
}

function filterRows(q){
  if(!q) return dataRows;
  const s = q.toLowerCase();
  return dataRows.filter(r => [r.name,r.station,r.division,r.bureau,r.radio].some(v => (v||"").toLowerCase().includes(s)));
}

function colIndexBy(headers, aliases){
  const H = headers.map(h=>norm(h).toLowerCase());
  for(const a of aliases){
    const key = norm(a).toLowerCase();
    const i = H.findIndex(h=>h===key);
    if(i!==-1) return i;
  }
  return -1;
}

function parseCsvRows(rows, mapping){
  if(!rows || rows.length<2) throw new Error('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô CSV');
  const headers = rows[0];
  const idx = {};
  for(const k of Object.keys(mapping)){
    idx[k] = colIndexBy(headers, mapping[k]);
  }
  return { rows, idx };
}

function toNum(v){
  if(v==null) return NaN;
  let s = String(v).trim();
  if((s.split(',').length-1)===1 && s.indexOf('.')===-1){ s = s.replace(',', '.'); }
  const allowed = '0123456789.-';
  s = Array.from(s).filter(ch => allowed.indexOf(ch)!==-1).join('');
  const num = parseFloat(s);
  return isNaN(num)? NaN : num;
}

function loadCsv(url){
  return new Promise((resolve,reject)=>{
    Papa.parse(url, { download:true, complete:res=>resolve(res.data), error:err=>reject(err) });
  });
}

async function loadAllCSVs(){
  toast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏´‡∏•‡∏≤‡∏¢‡∏ä‡∏µ‡∏ï...');
  const [rowsI, rowsS, rowsD, rowsB] = await Promise.all([
    loadCsv(INTERSECTION_CSV_URL),
    loadCsv(STATION_CSV_URL),
    loadCsv(DIVISION_CSV_URL),
    loadCsv(BUREAU_CSV_URL)
  ]);

  // Intersection
  const { idx: idxI } = parseCsvRows(rowsI, COLS);
  const intersections = [];
  let badI=0;
  for(let i=1;i<rowsI.length;i++){
    const r = rowsI[i]; if(!r||r.length===0) continue;
    const lat = toNum(r[idxI.lat]);
    const lng = toNum(r[idxI.lng]);
    if(isNaN(lat)||isNaN(lng)){ badI++; continue; }
    intersections.push({
      name: r[idxI.name],
      station: r[idxI.station],
      radio: r[idxI.radio],
      lat, lng
    });
  }

  // Station map: station_name -> division_name
  const { idx: idxS } = parseCsvRows(rowsS, COLS_STATION);
  const stationToDivision = new Map();
  for(let i=1;i<rowsS.length;i++){
    const r = rowsS[i]; if(!r||r.length===0) continue;
    const st = norm(r[idxS.station_name]);
    const dv = norm(r[idxS.division_name]);
    if(st) stationToDivision.set(st, dv);
  }

  // Division map: division_name -> bureau_name
  const { idx: idxD } = parseCsvRows(rowsD, COLS_DIVISION);
  const divisionToBureau = new Map();
  for(let i=1;i<rowsD.length;i++){
    const r = rowsD[i]; if(!r||r.length===0) continue;
    const dv = norm(r[idxD.division_name]);
    const bc = norm(r[idxD.bureau_name]);
    if(dv) divisionToBureau.set(dv, bc);
  }

  // Bureau list (optional validate)
  const { idx: idxB } = parseCsvRows(rowsB, COLS_BUREAU);
  const bureauSet = new Set();
  for(let i=1;i<rowsB.length;i++){
    const r = rowsB[i]; if(!r||r.length===0) continue;
    const bc = norm(r[idxB.bureau_name]);
    if(bc) bureauSet.add(bc);
  }

  console.log('[CSV] intersections:', intersections.length, 'bad:', badI, 'stations:', stationToDivision.size, 'divisions:', divisionToBureau.size, 'bureaus:', bureauSet.size);
  return { intersections, stationToDivision, divisionToBureau, bureauSet };
};
          const out = [];
let bad = 0;
function toNum(v){
  if(v==null) return NaN;
  let s = String(v).trim();
  // ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö 13,7563 ‚Üí 13.7563
  if((s.split(',').length-1)===1 && s.indexOf('.')===-1){ s = s.replace(',', '.'); }
  // ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç ‡∏à‡∏∏‡∏î ‡∏•‡∏ö
  const allowed = '0123456789.-';
  s = Array.from(s).filter(ch => allowed.indexOf(ch)!==-1).join('');
  const num = parseFloat(s);
  return isNaN(num)? NaN : num;
}
for (let i=1;i<rows.length;i++){
  const r = rows[i];
  if(!r || r.length===0) continue;
  const lat = toNum(r[idx.lat]);
  const lng = toNum(r[idx.lng]);
  if(isNaN(lat) || isNaN(lng)){ bad++; continue; }
  out.push({
    name: r[idx.name],
    station: r[idx.station],
    division: r[idx.division],
    bureau: r[idx.bureau],
    radio: r[idx.radio],
    lat, lng
  });
}
console.log('[CSV] total rows:', rows.length-1, 'valid coords:', out.length, 'skipped:', bad);
// ‡πÄ‡∏ï‡∏¥‡∏°‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏≤‡∏¢‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏≤‡∏ï‡∏≤‡∏°‡∏Å‡∏é
for(let i=0;i<out.length;i++){ out[i] = normalizeHierarchy(out[i]); }
resolve(out);

        } catch(err){ reject(err); }
      },
      error: (err) => reject(err)
    });
  });
}

let legendControl = null;
function ensureMap(){
  if(map) return;
  map = L.map('map');
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19, attribution: '&copy; OpenStreetMap'
  }).addTo(map);
  map.setView([13.7563, 100.5018], 11); // ‡∏Å‡∏ó‡∏°. ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô

  legendControl = L.control({ position: 'bottomright' });
  legendControl.onAdd = function(){
    const div = L.DomUtil.create('div','legend');
    div.innerHTML = '<b>‡∏™‡∏µ‡∏ï‡∏≤‡∏° ‡∏ö‡∏Å.</b><div id="legendList"></div>';
    return div;
  };
  legendControl.addTo(map);
}
function updateLegend(rows){
  const el = document.getElementById('legendList');
  if(!el) return;
  const divs = Array.from(new Set(rows.map(r=>normalizeUnitText(r.division)).filter(Boolean)));
  el.innerHTML = divs.map(d=>'<div class="row"><span class="sw" style="background:${getDivisionColor(d)}"></span>${d}</div>').join('');
}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19, attribution: '&copy; OpenStreetMap'
  }).addTo(map);
  map.setView([13.7563, 100.5018], 11); // ‡∏Å‡∏ó‡∏°. ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
}

function locateOnce(){
  if(!navigator.geolocation){ toast('‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á'); return; }
  navigator.geolocation.getCurrentPosition(pos => {
    const { latitude, longitude, accuracy } = pos.coords;
    // ‡∏•‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°
    if(userMarker){ map.removeLayer(userMarker); userMarker=null; }
    if(userCircle){ map.removeLayer(userCircle); userCircle=null; }
    userMarker = L.marker([latitude, longitude], { title: '‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô' }).bindPopup('‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô');
    userMarker.addTo(map);
    userCircle = L.circle([latitude, longitude], { radius: accuracy||50 });
    userCircle.addTo(map);
    map.setView([latitude, longitude], 14);
  }, err => {
    toast('‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á');
  }, { enableHighAccuracy:true, timeout:8000 });
}

// ====== ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÅ‡∏ö‡∏ö‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á ======
function updateUserLocation(latitude, longitude, accuracy){
  if(!userMarker){
    userMarker = L.marker([latitude, longitude], { title: '‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô', icon: userIcon }).bindPopup('‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô');
    userMarker.addTo(map);
  } else {
    userMarker.setLatLng([latitude, longitude]);
  }
  if(!userCircle){
    userCircle = L.circle([latitude, longitude], { radius: accuracy||50 });
    userCircle.addTo(map);
  } else {
    userCircle.setLatLng([latitude, longitude]);
    userCircle.setRadius(accuracy||50);
  }
}
function startWatch(){
  if(!navigator.geolocation){ toast('‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á'); return; }
  if(watchId!=null){ toast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß'); return; }
  watchId = navigator.geolocation.watchPosition(pos => {
    const { latitude, longitude, accuracy } = pos.coords;
    updateUserLocation(latitude, longitude, accuracy);
    if(following){ map.setView([latitude, longitude], Math.max(14, map.getZoom())); }
  }, err => {
    toast('‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á');
    stopWatch();
  }, { enableHighAccuracy:true, maximumAge: 3000, timeout:10000 });
  const b = document.getElementById('locBtn'); if(b) b.textContent = '‡∏´‡∏¢‡∏∏‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏â‡∏±‡∏ô';
  toast('‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á');
}
function stopWatch(){
  if(watchId!=null){ navigator.geolocation.clearWatch(watchId); watchId = null; }
  const b = document.getElementById('locBtn'); if(b) b.textContent = '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏â‡∏±‡∏ô';
  toast('‡∏´‡∏¢‡∏∏‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á');
}
// ====== /‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á ======

async function init(){
  ensureMap();
  try{
    const { intersections, stationToDivision, divisionToBureau } = await loadAllCSVs();
    // ‡πÄ‡∏ï‡∏¥‡∏° division / bureau ‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå
    dataRows = intersections.map(o=>{
      const st = normalizeUnitText(o.station);
      const dv = normalizeUnitText(stationToDivision.get(st) || '');
      const bc = normalizeUnitText(divisionToBureau.get(dv) || '');
      return { ...o, division: dv, bureau: bc };
    });
    plotMarkers(dataRows);
    toast('‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${dataRows.length} ‡∏à‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß');
  }catch(e){
    console.error(e); toast('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+(e?.message||''));
  }
} ‡∏à‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß');
  }catch(e){
    console.error(e); toast('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+ (e?.message||''));
  }
}

// UI events
window.addEventListener('DOMContentLoaded', () => {
  init();
  document.getElementById('locBtn').onclick = ()=>{ if(watchId==null) startWatch(); else stopWatch(); };
  document.getElementById('reloadBtn').onclick = init;
  const search = document.getElementById('search');
  search.addEventListener('input', (e)=>{
    const rows = filterRows(e.target.value);
    plotMarkers(rows);
  });
});
</script>
</body>
</html>
